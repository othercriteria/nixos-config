# Security Retro: Home Assistant Vulnerability Scanner

**Date**: 2026-01-09 15:49 EST
**Severity**: Low
**Duration**: ~90 seconds (automated scan)
**Impact**: None (all probes failed or returned benign data)

## Summary

An automated vulnerability scanner from an AWS EC2 instance
(`13.231.234.47`, `ap-northeast-1`) probed `assistant.valueof.info` with
152 requests over ~90 seconds, looking for common misconfigurations and
sensitive files.

## Attack Details

- **Source**: `ec2-13-231-234-47.ap-northeast-1.compute.amazonaws.com`
- **User-Agent**: `python-httpx/0.28.1` (automated scanner)
- **Targets probed**:
  - `.env` files (27 variations)
  - `.git/config` (14 variations)
  - SQL dumps (`backup.sql`, `dump.sql`, etc.)
  - PHP info pages (`phpinfo.php`, `info.php`, etc.)
  - AWS/Azure/GCP credentials
  - Docker/Kubernetes configs
  - Laravel/Drupal/Magento configs

## What Worked

| Defense | Status | Notes |
|---------|--------|-------|
| TLS/HTTPS | ✅ | All traffic encrypted |
| Auth on `/api/` | ✅ | Returned 401, triggered HA notification |
| Security headers | ✅ | HSTS, X-Content-Type-Options, etc. |
| No sensitive files exposed | ✅ | All probes returned 404 |

## What Failed

| Defense | Status | Notes |
|---------|--------|-------|
| **Fail2ban** | ❌ | Not monitoring log file (wrong backend) |
| Rate limiting | ⚠️ | 1 req/sec was under 60 req/s limit |

## Root Cause

Fail2ban was configured with `logpath` but NixOS defaults to
`backend = systemd`, which ignores file paths. The jail was "active" but
not actually monitoring the nginx log.

## Fixes Applied

1. **Fail2ban backend**: Added `backend = "polling"` to read nginx logs
1. **Scanner detection**: Expanded filter to catch probes for:
   - `.env`, `.git`, `.sql`, `.php` files
   - AWS/Docker/GCP credentials
   - phpinfo pages

With the new filter, this scanner would have been banned after 5 hits
(~5 seconds into the attack) instead of completing 152 requests.

## Lessons Learned

1. **Verify defenses work** — The jail appeared active but wasn't
   monitoring anything. Should have tested with
   `fail2ban-client get <jail> logpath` during initial setup.
1. **Test regex patterns** — `fail2ban-regex` is essential for verifying
   filters match expected patterns.
1. **Defense in depth** — Rate limiting alone wasn't sufficient; scanner
   stayed under threshold. Multiple detection methods are needed.

## Follow-up Actions

- [ ] Consider adding Prometheus alert for high 404 rate
- [ ] Review other fail2ban jails for same backend issue
- [ ] Consider stricter rate limits for non-authenticated endpoints
