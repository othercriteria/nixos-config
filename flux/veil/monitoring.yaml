apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
  namespace: flux-system
spec:
  interval: 10m
  install:
    createNamespace: true
  targetNamespace: monitoring
  chart:
    spec:
      chart: kube-prometheus-stack
      version: 66.3.0
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: flux-system
  values:
    defaultRules:
      create: true
      rules:
        alertmanager: true
        etcd: true
        general: true
        kubeApiserver: true
        kubeControllerManager: true
        kubeScheduler: true
        kubeStateMetrics: true
        kubelet: true
        node: true
        prometheus: true
    kubeEtcd:
      enabled: false
    prometheus:
      prometheusSpec:
        additionalScrapeConfigsSecret: additional-scrape-configs
      ingress:
        enabled: true
        ingressClassName: nginx
        hosts:
          - prometheus.veil.home.arpa
        paths:
          - /
        pathType: Prefix
    grafana:
      service:
        type: ClusterIP
      ingress:
        enabled: true
        ingressClassName: nginx
        hosts:
          - grafana.veil.home.arpa
        path: /
        pathType: Prefix
      sidecar:
        dashboards:
          enabled: true
          label: grafana_dashboard
          searchNamespace: ALL
      dashboards:
        default:
          node-exporter-full:
            gnetId: 1860
            revision: 33
            datasource: Prometheus
          k8s-views-nodes:
            gnetId: 15759
            revision: 22
            datasource: Prometheus
          k8s-views-pods:
            gnetId: 15760
            revision: 25
            datasource: Prometheus
    alertmanager:
      ingress:
        enabled: true
        ingressClassName: nginx
        hosts:
          - alertmanager.veil.home.arpa
        paths:
          - /
        pathType: Prefix
